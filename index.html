<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1">
<meta name="mobile-web-app-capable" content="yes">
<title>MarketLens</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300..700;1,9..40,300..700&display=swap" rel="stylesheet">
<style>
:root{
  --ink:#1a3a40;--ink2:#3d6269;--muted:#8c9a9d;
  --bg:#f4f1ec;--surface:#ffffff;--surface2:#faf8f5;--elevated:#fff;
  --border:#e5e0d8;--hair:#ede9e3;
  --accent:#23545b;--accent-s:rgba(35,84,91,.06);--accent-m:rgba(35,84,91,.12);--accent-h:#1c4a50;
  --ok:#3d8b5e;--ok-s:rgba(61,139,94,.08);--ok-b:rgba(61,139,94,.15);
  --err:#c0392b;--err-s:rgba(192,57,43,.07);
  --warn:#b8943d;--warn-s:rgba(184,148,61,.08);
  --gold:#c9a66c;--gold-s:rgba(201,166,108,.1);
  --font:'DM Sans',-apple-system,BlinkMacSystemFont,system-ui,sans-serif;
  --tab-h:58px;--hdr-h:56px;--safe-t:env(safe-area-inset-top,0px);--safe-b:env(safe-area-inset-bottom,0px);
  --r:14px;--r-s:10px;--r-xs:6px;--r-f:9999px;
  --sh-1:0 1px 3px rgba(26,58,64,.04),0 4px 12px rgba(26,58,64,.03);
  --sh-2:0 2px 8px rgba(26,58,64,.06),0 8px 24px rgba(26,58,64,.05);
  --sh-3:0 4px 16px rgba(26,58,64,.08),0 16px 48px rgba(26,58,64,.06);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{height:100%;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}
body{height:100%;font-family:var(--font);font-size:15px;line-height:1.5;color:var(--ink);background:var(--bg);overflow:hidden;-webkit-font-smoothing:antialiased}
a{color:var(--accent);text-decoration:none}
button{font-family:inherit;font-size:inherit;cursor:pointer;border:none;background:none;color:inherit;-webkit-appearance:none}
input,textarea,select{font-family:inherit;font-size:16px;color:var(--ink);-webkit-appearance:none;border:none;outline:none;background:none}
img{max-width:100%;display:block}

#app{height:100%;display:flex;flex-direction:column;padding-top:var(--safe-t)}
.app-c{flex:1;position:relative;overflow:hidden}
.view{position:absolute;inset:0;display:none;flex-direction:column;background:var(--bg);overflow:hidden}
.view.on{display:flex}

/* TAB BAR */
.tabs{display:flex;background:var(--surface);border-top:1px solid var(--hair);padding:4px 8px;padding-bottom:calc(4px + var(--safe-b));flex-shrink:0;z-index:30;gap:4px}
.tab{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 0 5px;color:var(--muted);font-size:10px;font-weight:500;letter-spacing:.02em;transition:all .2s;min-height:var(--tab-h);justify-content:center;position:relative;border-radius:var(--r-s)}
.tab svg{width:21px;height:21px;transition:all .2s;stroke-width:1.8}
.tab.on{color:var(--accent);background:var(--accent-s)}
.tab.on svg{stroke-width:2.2;transform:translateY(-1px)}
.tab .bdg{position:absolute;top:3px;right:50%;margin-right:-18px;background:var(--accent);color:#fff;font-size:9px;font-weight:700;min-width:17px;height:17px;border-radius:var(--r-f);display:flex;align-items:center;justify-content:center;padding:0 5px;box-shadow:0 2px 6px rgba(35,84,91,.3)}

/* HEADER */
.hdr{position:sticky;top:0;z-index:10;background:var(--surface);background-image:linear-gradient(180deg,var(--surface) 60%,var(--surface2));border-bottom:1px solid var(--hair);padding:0 16px;min-height:var(--hdr-h);display:flex;align-items:center;gap:12px;flex-shrink:0}
.hdr-t{font-size:22px;font-weight:700;color:var(--ink);letter-spacing:-.04em;flex:1}
.hdr-b{width:40px;height:40px;display:flex;align-items:center;justify-content:center;color:var(--muted);border-radius:var(--r-s);transition:all .15s}
.hdr-b:active{background:var(--accent-s);color:var(--accent)}
.hdr-mark{width:30px;height:30px;flex-shrink:0}

/* SEARCH */
.srch{display:flex;align-items:center;gap:8px;background:var(--bg);border:1.5px solid var(--hair);border-radius:var(--r);padding:0 12px;height:42px;margin:12px 16px 0;transition:border-color .15s}
.srch:focus-within{border-color:var(--accent);background:var(--surface)}
.srch svg{color:var(--muted);flex-shrink:0;width:17px;height:17px}
.srch input{flex:1;padding:8px 0}
.srch input::placeholder{color:var(--muted)}

/* CHIPS */
.chips{display:flex;gap:8px;overflow-x:auto;padding:12px 16px 4px;scrollbar-width:none;-webkit-overflow-scrolling:touch}
.chips::-webkit-scrollbar{display:none}
.ch{padding:7px 14px;border-radius:var(--r-f);font-size:13px;font-weight:500;white-space:nowrap;border:1.5px solid var(--border);color:var(--ink2);background:var(--surface);transition:all .2s;flex-shrink:0;display:flex;align-items:center;gap:5px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
.ch:active{transform:scale(.97)}.ch.on{background:var(--accent);color:#fff;border-color:var(--accent);box-shadow:0 2px 8px rgba(35,84,91,.25)}

/* CARDS (doc items) */
.dc{margin:6px 16px;background:var(--surface);border-radius:var(--r-s);border:1px solid var(--hair);box-shadow:var(--sh-1);transition:all .15s;overflow:hidden}
.dc:active{box-shadow:var(--sh-2);transform:scale(.99)}
.dc-in{display:flex;align-items:center;gap:12px;padding:14px 14px 14px 0}
.dc-strip{width:4px;flex-shrink:0;align-self:stretch;border-radius:0 2px 2px 0}
.dc-strip.t-research{background:var(--accent)}.dc-strip.t-analysis{background:var(--ok)}.dc-strip.t-valuation{background:var(--warn)}.dc-strip.t-ecosystem{background:#7a8a5a}.dc-strip.t-default{background:var(--border)}
.dc-bd{flex:1;min-width:0}
.dc-t{font-size:15px;font-weight:600;color:var(--ink);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;letter-spacing:-.01em}
.dc-meta{display:flex;align-items:center;gap:6px;margin-top:3px;font-size:12px;color:var(--muted)}
.dc-meta .dt{width:3px;height:3px;border-radius:50%;background:var(--muted);opacity:.5}
.dc-type{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.04em;padding:2px 7px;border-radius:var(--r-xs);background:var(--bg)}
.dc-star{color:var(--gold);flex-shrink:0;margin-right:2px}
.dc-star svg{width:14px;height:14px;fill:var(--gold);stroke:var(--gold)}
.dc-arr{color:var(--border);flex-shrink:0;margin-right:4px}
.dc-arr svg{width:14px;height:14px}

/* FLAT LIST (settings, ws picker) */
.li{display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid var(--hair);background:var(--surface);transition:background .1s}
.li:active{background:var(--accent-s)}.li:last-child{border-bottom:none}
.li-ic{width:38px;height:38px;border-radius:var(--r-s);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.li-ic svg{width:18px;height:18px}
.li-ic.doc{background:var(--accent-s);color:var(--accent)}
.li-ic.ws{background:var(--warn-s);color:var(--warn)}
.li-bd{flex:1;min-width:0}
.li-t{font-size:15px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.li-s{font-size:12px;color:var(--muted);margin-top:1px;display:flex;align-items:center;gap:6px}
.li-s .dt{width:3px;height:3px;border-radius:50%;background:var(--muted)}
.li-star{color:var(--gold);flex-shrink:0}
.li-star svg{width:14px;height:14px;fill:var(--gold);stroke:var(--gold)}
.li-arr{color:var(--border);flex-shrink:0}
.li-arr svg{width:16px;height:16px}
.sec{padding:24px 16px 8px;font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}

/* WORKSPACE CARD (in ws list) */
.wsc{margin:8px 16px;background:var(--surface);border-radius:var(--r);border:1px solid var(--hair);box-shadow:var(--sh-1);overflow:hidden;transition:all .15s}
.wsc:active{box-shadow:var(--sh-2);transform:scale(.99)}
.wsc-in{display:flex;align-items:center;gap:14px;padding:16px}
.wsc-ic{width:44px;height:44px;border-radius:var(--r-s);display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--accent-s),var(--accent-m));color:var(--accent)}
.wsc-ic svg{width:20px;height:20px}
.wsc-bd{flex:1;min-width:0}
.wsc-t{font-size:16px;font-weight:600;letter-spacing:-.02em}
.wsc-s{font-size:12px;color:var(--muted);margin-top:2px}
.wsc-arr{color:var(--border)}.wsc-arr svg{width:16px;height:16px}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 20px;border-radius:var(--r-s);font-size:15px;font-weight:600;min-height:48px;transition:all .2s}
.btn:active{transform:scale(.98)}
.btn-p{background:linear-gradient(180deg,#2a6068,var(--accent));color:#fff;box-shadow:0 2px 8px rgba(35,84,91,.25)}
.btn-p:active{background:var(--accent-h);box-shadow:0 1px 4px rgba(35,84,91,.2)}.btn-p:disabled{opacity:.4;pointer-events:none;box-shadow:none}
.btn-s{background:var(--surface);color:var(--accent);border:1.5px solid var(--border);box-shadow:var(--sh-1)}.btn-s:active{background:var(--accent-s)}
.btn-w{width:100%}.btn-sm{padding:8px 14px;font-size:13px;min-height:36px;border-radius:var(--r-xs)}

/* TOGGLE */
.tgl{display:flex;background:var(--bg);border-radius:var(--r-s);border:1.5px solid var(--hair);overflow:hidden}
.tgl-o{flex:1;padding:9px 6px;text-align:center;font-size:13px;font-weight:500;color:var(--muted);transition:all .2s}
.tgl-o.on{background:var(--accent);color:#fff;box-shadow:inset 0 1px 0 rgba(255,255,255,.15)}

/* FORM */
.fg{margin-bottom:18px}
.fl{display:block;font-size:11px;font-weight:600;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.06em}
.fi{width:100%;padding:12px 14px;border:1.5px solid var(--border);border-radius:var(--r-s);background:var(--surface);font-size:16px;line-height:1.5;transition:all .2s;box-shadow:var(--sh-1)}
.fi:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-s)}
textarea.fi{resize:vertical;min-height:80px}

/* WELCOME CARD (library empty state) */
.wel{margin:16px;padding:28px 24px;background:linear-gradient(145deg,#2a6068 0%,var(--accent) 40%,#1c4a50 100%);border-radius:var(--r);color:#fff;position:relative;overflow:hidden;box-shadow:0 4px 20px rgba(35,84,91,.3)}
.wel::after{content:'';position:absolute;top:-30%;right:-20%;width:60%;height:160%;background:radial-gradient(circle,rgba(255,255,255,.06) 0%,transparent 70%);pointer-events:none}
.wel-t{font-size:22px;font-weight:700;letter-spacing:-.03em;margin-bottom:4px;position:relative;z-index:1}
.wel-s{font-size:14px;opacity:.7;margin-bottom:20px;line-height:1.5;position:relative;z-index:1}
.wel .btn{background:rgba(255,255,255,.18);color:#fff;border:1px solid rgba(255,255,255,.25);box-shadow:0 2px 8px rgba(0,0,0,.15);backdrop-filter:blur(4px);position:relative;z-index:1}
.wel .btn:active{background:rgba(255,255,255,.28)}

/* EMPTY */
.emp{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:48px 32px;text-align:center;color:var(--muted);gap:12px}
.emp svg{width:48px;height:48px;opacity:.2}
.emp-t{font-size:16px;font-weight:600;color:var(--ink2)}
.emp p{font-size:13px;max-width:220px;line-height:1.6}
.emp .btn{margin-top:8px}

/* JOB CARD */
.jc{background:var(--surface);border:1px solid var(--hair);border-radius:var(--r);margin:0 16px 10px;overflow:hidden;box-shadow:var(--sh-1);display:flex}
.jc-st-strip{width:4px;flex-shrink:0}
.jc-st-strip.run{background:var(--accent);animation:pulse-strip 2s ease-in-out infinite}
.jc-st-strip.done{background:var(--ok)}
.jc-st-strip.fail{background:var(--err)}
@keyframes pulse-strip{0%,100%{opacity:1}50%{opacity:.4}}
.jc-inner{flex:1;padding:14px 16px;display:flex;gap:12px;align-items:flex-start}
.jc-ic{width:36px;height:36px;border-radius:var(--r-s);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.jc-ic svg{width:18px;height:18px}
.jc-ic.run{background:var(--accent-s);color:var(--accent)}
.jc-ic.done{background:var(--ok-s);color:var(--ok)}
.jc-ic.fail{background:var(--err-s);color:var(--err)}
.jc-bd{flex:1;min-width:0}
.jc-n{font-weight:600;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;letter-spacing:-.01em}
.jc-st{font-size:12px;color:var(--muted);margin-top:2px}
.jc-bar{height:4px;background:var(--hair);border-radius:3px;overflow:hidden;margin-top:10px}
.jc-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--accent),#3d8b5e);animation:prog 3s ease-in-out infinite}
.jc-acts{display:flex;gap:8px;margin-top:10px}
@keyframes prog{0%{width:10%}50%{width:70%}100%{width:92%}}

.scr{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch}

/* READER */
.rdr{position:fixed;inset:0;z-index:50;background:var(--surface2);display:flex;flex-direction:column;transform:translateX(100%);transition:transform .3s cubic-bezier(.25,.1,.25,1);will-change:transform}
.rdr.open{transform:translateX(0)}
.rdr-h{display:flex;align-items:center;padding:8px 8px 8px 4px;padding-top:calc(8px + var(--safe-t));background:var(--surface);border-bottom:1px solid var(--hair);min-height:calc(var(--hdr-h) + var(--safe-t));flex-shrink:0;z-index:2;transition:transform .2s,opacity .2s;box-shadow:0 1px 4px rgba(0,0,0,.03)}
.rdr-h.hid{transform:translateY(-100%);opacity:0;pointer-events:none}
.rdr-bk,.rdr-mr{width:44px;height:44px;display:flex;align-items:center;justify-content:center}
.rdr-bk{color:var(--accent)}.rdr-mr{color:var(--muted)}
.rdr-tt{flex:1;font-size:15px;font-weight:600;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;padding:0 4px}
.rdr-bd{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:28px 22px 48px}
.rdr-bar{display:flex;align-items:center;justify-content:space-around;padding:6px 12px;padding-bottom:calc(6px + var(--safe-b));background:var(--surface);border-top:1px solid var(--hair);flex-shrink:0;z-index:2;box-shadow:0 -1px 4px rgba(0,0,0,.03)}
.rdr-a{display:flex;flex-direction:column;align-items:center;gap:3px;padding:8px 14px;color:var(--muted);font-size:10px;font-weight:500;border-radius:var(--r-s);transition:all .15s;min-width:52px}
.rdr-a:active{color:var(--accent);background:var(--accent-s)}
.rdr-a svg{width:20px;height:20px}

/* MARKDOWN */
.md h1{font-size:24px;font-weight:700;color:var(--ink);letter-spacing:-.03em;line-height:1.3;margin:0 0 20px;padding-bottom:14px;border-bottom:2px solid var(--accent)}
.md h2{font-size:18px;font-weight:600;color:var(--ink);letter-spacing:-.02em;margin:28px 0 12px;padding-left:12px;border-left:3px solid var(--accent)}
.md h3{font-size:16px;font-weight:600;margin:20px 0 8px}
.md p{font-size:16px;line-height:1.8;margin-bottom:14px;color:var(--ink2)}
.md strong{font-weight:600;color:var(--ink)}
.md a{color:var(--accent);text-decoration:underline;text-underline-offset:2px}
.md ul,.md ol{margin:12px 0;padding-left:24px}
.md ul{list-style:disc}.md ol{list-style:decimal}
.md li{font-size:16px;line-height:1.7;margin-bottom:6px;color:var(--ink2)}
.md li::marker{color:var(--accent)}
.md table{width:100%;border-collapse:collapse;margin:16px 0;font-size:13px;display:block;overflow-x:auto;border-radius:var(--r-xs);overflow:hidden}
.md th{background:var(--accent);color:#fff;padding:10px 12px;text-align:left;font-weight:600;white-space:nowrap}
.md td{padding:10px 12px;border-bottom:1px solid var(--hair)}
.md tr:nth-child(even) td{background:var(--surface2)}
.md blockquote{border-left:3px solid var(--accent);padding:12px 16px;margin:14px 0;background:var(--accent-s);border-radius:0 var(--r-s) var(--r-s) 0;font-style:italic;color:var(--ink2)}
.md hr{border:none;border-top:1px solid var(--border);margin:28px 0}
.md code{font-family:'SF Mono',Menlo,monospace;font-size:.88em;background:var(--bg);padding:2px 6px;border-radius:4px;color:var(--accent)}

/* SHEET */
.sh-bg{position:fixed;inset:0;background:rgba(26,58,64,.35);backdrop-filter:blur(3px);z-index:100;opacity:0;pointer-events:none;transition:opacity .25s}
.sh-bg.on{opacity:1;pointer-events:auto}
.sh{position:fixed;left:0;right:0;bottom:0;background:var(--surface);border-radius:18px 18px 0 0;z-index:101;transform:translateY(100%);transition:transform .3s cubic-bezier(0,0,.2,1);max-height:80vh;display:flex;flex-direction:column;padding-bottom:var(--safe-b);box-shadow:var(--sh-3)}
.sh.on{transform:translateY(0)}
.sh-hl{width:36px;height:4px;background:var(--border);border-radius:4px;margin:8px auto 4px;flex-shrink:0}
.sh-hd{display:flex;align-items:center;justify-content:space-between;padding:4px 16px 12px;border-bottom:1px solid var(--hair);flex-shrink:0}
.sh-tt{font-size:17px;font-weight:700;letter-spacing:-.02em}
.sh-x{width:32px;height:32px;display:flex;align-items:center;justify-content:center;color:var(--muted);border-radius:50%;transition:background .15s}
.sh-x:active{background:var(--bg)}
.sh-bd{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:16px}

/* CHAT */
.c-msgs{display:flex;flex-direction:column;gap:12px;min-height:200px;padding-bottom:8px}
.c-m{max-width:85%}.c-m.u{align-self:flex-end}.c-m.a{align-self:flex-start}
.c-b{padding:10px 14px;border-radius:16px;font-size:15px;line-height:1.55}
.c-m.u .c-b{background:linear-gradient(135deg,#2a6068,var(--accent));color:#fff;border-bottom-right-radius:4px;box-shadow:0 2px 6px rgba(35,84,91,.2)}
.c-m.a .c-b{background:var(--bg);color:var(--ink);border-bottom-left-radius:4px}
.c-t{font-size:11px;color:var(--muted);margin-top:2px;padding:0 6px}
.c-m.u .c-t{text-align:right}
.c-in{display:flex;align-items:flex-end;gap:8px;padding:12px 16px;border-top:1px solid var(--hair);background:var(--surface);flex-shrink:0}
.c-in textarea{flex:1;border:1.5px solid var(--border);border-radius:20px;padding:9px 14px;font-size:15px;max-height:100px;resize:none;background:var(--bg);line-height:1.4;transition:border-color .15s}
.c-in textarea:focus{border-color:var(--accent)}
.c-snd{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#2a6068,var(--accent));color:#fff;display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 2px 6px rgba(35,84,91,.25)}
.c-snd:active{transform:scale(.95)}

/* THINKING */
.thk{display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--bg);border-radius:16px;border-bottom-left-radius:4px;max-width:200px;font-size:13px;color:var(--muted)}
.thk-d{display:flex;gap:4px}
.thk-d span{width:5px;height:5px;background:var(--accent);border-radius:50%;opacity:.5;animation:bounce 1.2s ease-in-out infinite}
.thk-d span:nth-child(2){animation-delay:.15s}
.thk-d span:nth-child(3){animation-delay:.3s}
@keyframes bounce{0%,60%,100%{transform:translateY(0);opacity:.5}30%{transform:translateY(-5px);opacity:1}}

/* TOAST */
.toast-c{position:fixed;top:calc(var(--safe-t) + 12px);left:16px;right:16px;z-index:200;pointer-events:none}
.tst{background:var(--ink);color:#fff;padding:12px 16px;border-radius:var(--r-s);font-size:13px;font-weight:500;box-shadow:var(--sh-3);transform:translateY(-20px);opacity:0;transition:all .3s;pointer-events:auto;margin-bottom:8px;display:flex;align-items:center;gap:8px}
.tst.show{transform:translateY(0);opacity:1}
.tst.err{background:var(--err)}.tst.ok{background:var(--ok)}

/* WS DETAIL */
.wsd{position:absolute;inset:0;display:none;flex-direction:column;background:var(--bg);z-index:5;overflow:hidden}
.wsd.open{display:flex}
.wsd-inf{padding:4px 16px 12px;font-size:13px;color:var(--muted);background:var(--surface);border-bottom:1px solid var(--hair)}
.wsd-btns{display:flex;gap:10px;padding:16px}
.wsd-btns .btn{flex:1}

/* LOADING */
.ld{position:fixed;inset:0;z-index:300;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;transition:opacity .3s}
.ld.hide{opacity:0;pointer-events:none}
.spin{width:28px;height:28px;border:2.5px solid var(--hair);border-top-color:var(--accent);border-radius:50%;animation:sp .7s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
.ld-t{font-size:13px;color:var(--muted)}

/* ADD TO WS SHEET */
.ws-pick .li{padding:12px 16px}
.ws-pick .li-ic{width:32px;height:32px}
.ws-chk{width:22px;height:22px;border:2px solid var(--border);border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .15s}
.ws-chk.on{background:var(--accent);border-color:var(--accent);box-shadow:0 1px 4px rgba(35,84,91,.3)}
.ws-chk.on svg{display:block}.ws-chk svg{display:none;width:12px;height:12px;color:#fff}

/* LOGIN */
.login{position:fixed;inset:0;z-index:400;background:linear-gradient(160deg,var(--bg) 30%,#e8e4dd 100%);display:flex;align-items:center;justify-content:center;transition:opacity .4s}
.login.hide{opacity:0;pointer-events:none}
.login-card{width:320px;max-width:90vw;background:var(--surface);border:1px solid var(--hair);border-radius:var(--r);padding:36px 28px;box-shadow:var(--sh-3);text-align:center}
.login-logo{width:56px;height:56px;margin:0 auto 20px}
.login-logo svg{width:56px;height:56px}
.login-title{font-size:24px;font-weight:700;letter-spacing:-.04em;margin-bottom:4px}
.login-sub{font-size:13px;color:var(--muted);margin-bottom:28px}
.login-input{width:100%;padding:13px 16px;border:1.5px solid var(--border);border-radius:var(--r-s);background:var(--bg);font-size:16px;text-align:center;letter-spacing:.1em;transition:all .2s;box-shadow:var(--sh-1)}
.login-input:focus{border-color:var(--accent);outline:none;box-shadow:0 0 0 3px var(--accent-s)}
.login-input::placeholder{letter-spacing:normal}
.login-err{font-size:12px;color:var(--err);margin-top:8px;min-height:18px}
.login-btn{width:100%;margin-top:14px}
.login-status{display:flex;align-items:center;justify-content:center;gap:6px;font-size:12px;color:var(--muted);margin-top:20px}
.login-dot{width:6px;height:6px;border-radius:50%;background:var(--muted)}
</style>
</head>
<body>
<div id="app">

<!-- LOGIN -->
<div class="login" id="login">
  <div class="login-card">
    <div class="login-logo"><svg viewBox="0 0 100 100" fill="none"><circle cx="50" cy="50" r="46" stroke="var(--accent)" stroke-width="6" opacity=".15"/><path d="M50 4a46 46 0 0 1 46 46" stroke="var(--accent)" stroke-width="6" stroke-linecap="round"/><path d="M50 4a46 46 0 0 0-36 18" stroke="#7ec8c8" stroke-width="6" stroke-linecap="round"/><path d="M14 22a46 46 0 0 0-6 38" stroke="#a8d8d8" stroke-width="6" stroke-linecap="round"/></svg></div>
    <div class="login-title">MarketLens</div>
    <div class="login-sub">Enter password to connect</div>
    <input type="password" class="login-input" id="login-pw" placeholder="Password" autocomplete="off">
    <div class="login-err" id="login-err"></div>
    <button class="btn btn-p btn-w login-btn" id="login-go" onclick="doLogin()">Connect</button>
    <div class="login-status"><div class="login-dot"></div><span>Vertesia API</span></div>
  </div>
</div>

<!-- LOADING -->
<div class="ld hide" id="ld">
  <svg width="48" height="48" viewBox="0 0 100 100" fill="none" style="margin-bottom:4px"><circle cx="50" cy="50" r="46" stroke="var(--hair)" stroke-width="8"/><path d="M50 4a46 46 0 0 1 46 46" stroke="var(--accent)" stroke-width="8" stroke-linecap="round"/><path d="M50 4a46 46 0 0 0-36 18" stroke="#7ec8c8" stroke-width="8" stroke-linecap="round"/></svg>
  <div class="spin"></div>
  <div class="ld-t" id="ld-t">Connecting to Vertesia...</div>
</div>

<div class="app-c">

<!-- LIBRARY (HOME) -->
<div id="v-lib" class="view on">
  <div class="hdr">
    <svg width="26" height="26" viewBox="0 0 100 100" fill="none"><circle cx="50" cy="50" r="46" stroke="var(--accent)" stroke-width="8" opacity=".2"/><path d="M50 4a46 46 0 0 1 46 46" stroke="var(--accent)" stroke-width="8" stroke-linecap="round"/><path d="M50 4a46 46 0 0 0-36 18" stroke="#7ec8c8" stroke-width="8" stroke-linecap="round"/><path d="M14 22a46 46 0 0 0-6 38" stroke="#a8d8d8" stroke-width="8" stroke-linecap="round"/></svg>
    <span class="hdr-t">MarketLens</span>
    <button class="hdr-b" onclick="openSh('sh-set')"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></button>
  </div>
  <div id="lib-activity"></div>
  <div style="padding:0 16px 8px">
    <div class="srch" style="margin:0">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input type="text" id="lib-q" placeholder="Search documents..." oninput="renderLib()">
    </div>
  </div>
  <div class="chips" id="lib-ch"></div>
  <div class="scr" id="lib-ls"></div>
</div>

<!-- RESEARCH -->
<div id="v-res" class="view">
  <div class="hdr"><span class="hdr-t">New Research</span></div>
  <div class="scr" style="padding:16px" id="res-form">
    <div id="r-parent" style="display:none;background:var(--accent-s);border:1px solid var(--accent-m);border-radius:var(--r-s);padding:12px 14px;margin-bottom:16px">
      <div style="display:flex;align-items:center;gap:8px">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
        <span style="font-size:11px;font-weight:600;color:var(--accent);text-transform:uppercase;letter-spacing:.04em">Follow-up Research</span>
        <button onclick="clearFollowUp()" style="margin-left:auto;color:var(--muted);padding:2px" title="Clear">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div id="r-parent-title" style="font-size:14px;font-weight:600;margin-top:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--ink)"></div>
      <div id="r-parent-meta" style="font-size:12px;color:var(--muted);margin-top:2px"></div>
    </div>
    <div class="fg"><label class="fl">Category</label><div class="chips" id="r-cats" style="padding:0;flex-wrap:wrap"></div></div>
    <div class="fg" id="r-fwg" style="display:none"><label class="fl">Framework</label><div class="chips" id="r-fws" style="padding:0;flex-wrap:wrap"></div></div>
    <div style="display:flex;gap:12px;margin-bottom:18px">
      <div class="fg" style="flex:1;margin:0"><label class="fl">Scope</label><div class="tgl" id="r-sc"><button class="tgl-o on" data-v="asset">Asset</button><button class="tgl-o" data-v="sector">Sector</button><button class="tgl-o" data-v="market">Market</button></div></div>
      <div class="fg" style="flex:1;margin:0"><label class="fl">Rigor</label><div class="tgl" id="r-ri"><button class="tgl-o" data-v="high-level">High Level</button><button class="tgl-o on" data-v="in-depth">In-Depth</button></div></div>
    </div>
    <div class="fg"><label class="fl">What are you researching?</label><textarea class="fi" id="r-ctx" rows="3" placeholder="Describe your research question..."></textarea></div>
    <div class="fg"><label class="fl">Add to Workspace</label><button class="btn btn-s btn-w" id="r-ws" style="justify-content:flex-start" onclick="openWsPick()"><span id="r-ws-label" style="color:var(--muted)">None — library only</span><svg style="margin-left:auto" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg></button></div>
    <button class="btn btn-p btn-w" id="r-go" onclick="doResearch()" style="margin-top:12px;min-height:52px;font-size:16px;border-radius:var(--r)">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      Generate Research
    </button>
    <p style="text-align:center;font-size:11px;color:var(--muted);margin-top:12px">Powered by Vertesia AI · Sources included</p>
  </div>
</div>

<!-- WORKSPACES -->
<div id="v-ws" class="view">
  <div class="hdr">
    <span class="hdr-t">Workspaces</span>
    <button class="hdr-b" onclick="newWorkspace()"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
  </div>
  <div class="scr" id="ws-ls"></div>
  <div class="wsd" id="wsd">
    <div class="hdr">
      <button class="hdr-b" onclick="closeWsd()" style="margin-left:-8px"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
      <span class="hdr-t" id="wsd-t">Workspace</span>
      <button class="hdr-b"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="5" r="1"/><circle cx="12" cy="12" r="1"/><circle cx="12" cy="19" r="1"/></svg></button>
    </div>
    <div class="wsd-inf" id="wsd-inf"></div>
    <div class="scr" id="wsd-docs"></div>
    <div class="wsd-btns">
      <button class="btn btn-s" onclick="wsNewResearch()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> Research</button>
      <button class="btn btn-s" onclick="openWsChat()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg> Chat</button>
      <button class="btn btn-s" onclick="openAddDocSheet()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Add</button>
    </div>
  </div>
</div>


</div>

<nav class="tabs" id="tabs">
  <button class="tab on" data-t="lib" onclick="go('lib')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg><span>Library</span></button>
  <button class="tab" data-t="res" onclick="go('res')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><span>Research</span></button>
  <button class="tab" data-t="ws" onclick="go('ws')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg><span>Workspaces</span></button>
</nav>
</div>

<!-- READER -->
<div class="rdr" id="rdr">
  <div class="rdr-h" id="rdr-h">
    <button class="rdr-bk" onclick="closeRdr()"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
    <span class="rdr-tt" id="rdr-tt"></span>
    <button class="rdr-mr" onclick="openRdrMenu()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="5" r="1"/><circle cx="12" cy="12" r="1"/><circle cx="12" cy="19" r="1"/></svg></button>
  </div>
  <div class="rdr-bd md" id="rdr-bd"></div>
  <div class="rdr-bar">
    <button class="rdr-a" onclick="openDocChat()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>Chat</button>
    <button class="rdr-a" onclick="openNotes()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>Notes</button>
    <button class="rdr-a" onclick="openFollowUp()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>Follow Up</button>
    <button class="rdr-a" onclick="toggleStar()"><svg id="rdr-star" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>Star</button>
  </div>
</div>

<div class="sh-bg" id="shbg" onclick="closeSh()"></div>

<!-- CHAT SHEET -->
<div class="sh" id="sh-chat" style="max-height:70vh">
  <div class="sh-hl"></div>
  <div class="sh-hd"><span class="sh-tt" id="sh-chat-t">Chat</span><button class="sh-x" onclick="closeSh()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
  <div class="sh-bd" style="padding:0;display:flex;flex-direction:column">
    <div class="c-msgs" id="c-msgs" style="flex:1;overflow-y:auto;padding:16px"></div>
  </div>
  <div class="c-in"><textarea id="c-inp" rows="1" placeholder="Ask about this document..."></textarea><button class="c-snd" onclick="sendChat()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button></div>
</div>

<!-- NOTES SHEET -->
<div class="sh" id="sh-notes" style="max-height:60vh">
  <div class="sh-hl"></div>
  <div class="sh-hd"><span class="sh-tt">Notes</span><button class="sh-x" onclick="closeSh()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
  <div class="sh-bd"><textarea class="fi" id="n-ed" rows="8" placeholder="Your notes..."></textarea><button class="btn btn-p btn-w" style="margin-top:12px" onclick="saveNote()">Save Notes</button></div>
</div>

<!-- WS PICK SHEET (for research) -->
<div class="sh" id="sh-wspick" style="max-height:60vh">
  <div class="sh-hl"></div>
  <div class="sh-hd"><span class="sh-tt">Add to Workspace</span><button class="sh-x" onclick="closeSh()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
  <div class="sh-bd ws-pick" id="wspick-ls" style="padding:0"></div>
</div>

<!-- ADD DOC TO WS SHEET -->
<div class="sh" id="sh-adddoc" style="max-height:70vh">
  <div class="sh-hl"></div>
  <div class="sh-hd"><span class="sh-tt">Add Documents</span><button class="sh-x" onclick="closeSh()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
  <div class="sh-bd" style="padding:0" id="adddoc-ls"></div>
  <div style="padding:12px 16px;border-top:1px solid var(--hair)"><button class="btn btn-p btn-w" onclick="confirmAddDocs()">Add Selected</button></div>
</div>

<!-- SETTINGS SHEET -->
<div class="sh" id="sh-set" style="max-height:55vh">
  <div class="sh-hl"></div>
  <div class="sh-hd"><span class="sh-tt">Settings</span><button class="sh-x" onclick="closeSh()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
  <div class="sh-bd" style="padding:0">
    <div class="sec">Connection</div>
    <div class="li"><div class="li-bd"><div class="li-t">API Status</div><div class="li-s" id="api-st"><span style="color:var(--muted)">Not connected</span></div></div></div>
    <div class="sec">Account</div>
    <div class="li"><div class="li-bd"><div class="li-t">Profile</div></div></div>
    <div class="li"><div class="li-bd"><div class="li-t">Support</div></div></div>
    <div class="li" onclick="closeSh();doLogout()" style="cursor:pointer"><div class="li-bd"><div class="li-t" style="color:var(--err)">Log Out</div></div></div>
    <div style="padding:20px;text-align:center"><p style="font-size:12px;color:var(--muted)">MarketLens v2.0</p></div>
  </div>
</div>

<div class="toast-c" id="toast-c"></div>

<script>
// ===== CONFIG =====
const CFG={
  BASE:'https://api.vertesia.io/api/v1',
  AUTH:'https://api.vertesia.io',
  KEY:'sk-57b1f54a776432c923f1f17551102bf3',
  ENV:'681915c6a01fb262a410c161',
  MODEL:'publishers/anthropic/models/claude-opus-4-5',
  INT_RES:'ResearchV2',
  INT_CHAT:'DocumentChat'
};

// ===== API =====
const API={
  jwt:null,jwtExp:0,
  async token(){
    if(this.jwt&&Date.now()<this.jwtExp)return this.jwt;
    const r=await fetch(`${CFG.AUTH}/auth/token?token=${CFG.KEY}`,{headers:{'Authorization':`Bearer ${CFG.KEY}`}});
    if(!r.ok)throw new Error('Auth failed');
    const d=await r.json();this.jwt=d.token;this.jwtExp=Date.now()+3e6;return this.jwt;
  },
  async call(ep,o={}){
    const r=await fetch(`${CFG.BASE}${ep}`,{...o,headers:{'Authorization':`Bearer ${CFG.KEY}`,'Content-Type':'application/json',...(o.headers||{})}});
    if(!r.ok){const e=await r.text().catch(()=>'');console.error('API',r.status,ep,e);throw new Error(`API ${r.status}`)}
    if(r.status===204)return null;const t=await r.text();return t?JSON.parse(t):null;
  },
  async callAuth(ep,o={}){
    const tk=await this.token();
    const r=await fetch(`${CFG.BASE}${ep}`,{...o,headers:{'Authorization':`Bearer ${tk}`,'Content-Type':'application/json',...(o.headers||{})}});
    if(!r.ok)throw new Error(`API ${r.status}`);const t=await r.text();return t?JSON.parse(t):null;
  },
  loadDocs(){return this.call('/objects?limit=1000&offset=0')},
  getDoc(id){return this.call(`/objects/${id}`)},
  async getContent(src){const{url}=await this.call('/objects/download-url',{method:'POST',body:JSON.stringify({file:src,format:'original'})});return(await fetch(url)).text()},
  loadColls(){return this.call('/collections/search',{method:'POST',body:JSON.stringify({dynamic:false,status:'active',limit:100})})},
  getMembers(cid){return this.call(`/collections/${cid}/members?limit=1000`)},
  createColl(name){return this.call('/collections',{method:'POST',body:JSON.stringify({name,description:'',dynamic:false})})},
  addToColl(cid,ids){return this.call(`/collections/${cid}/members`,{method:'POST',body:JSON.stringify({action:'add',members:ids})})},
  removeFromColl(cid,ids){return this.call(`/collections/${cid}/members`,{method:'POST',body:JSON.stringify({action:'delete',members:ids})})},
  execResearch(task){return this.callAuth('/execute/async',{method:'POST',body:JSON.stringify({type:'conversation',interaction:CFG.INT_RES,data:{Task:task},config:{environment:CFG.ENV,model:CFG.MODEL}})})},
  execChat(task){return this.callAuth('/execute/async',{method:'POST',body:JSON.stringify({type:'conversation',interaction:CFG.INT_CHAT,data:{task},config:{environment:CFG.ENV,model:CFG.MODEL},interactive:true,max_iterations:100})})},
  getRunStatus(wf,run){return this.call(`/workflows/runs/${wf}/${run}`)},
  async stream(wf,run,onMsg,onDone,onErr){
    try{const tk=await this.token();const r=await fetch(`${CFG.BASE}/workflows/runs/${wf}/${run}/stream?since=${Date.now()}&access_token=${tk}`);
    if(!r.ok)throw new Error('Stream '+r.status);const rd=r.body.getReader();const dec=new TextDecoder();let buf='';
    while(true){const{done,value}=await rd.read();if(done)break;buf+=dec.decode(value,{stream:true});const lns=buf.split('\n');buf=lns.pop();
    for(const l of lns){if(!l.startsWith('data:'))continue;try{const d=JSON.parse(l.slice(5).trim());if(onMsg)onMsg(d);if(d.type==='finish'||d.finish_reason==='stop'){if(onDone)onDone();return}}catch(e){}}}
    if(onDone)onDone()}catch(e){if(onErr)onErr(e)}
  },
  extractAnswer(m){if(!m)return'';const x=m.match(/\*\*3\.\s*Agent Answer:\*\*\s*([\s\S]*?)(?=\*\*\d+\.|$)/i);return x?x[1].trim():m}
};

// ===== SVG ICONS (no emojis) =====
const IC={
  doc:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',
  ws:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>',
  pin:'<svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1"><path d="M12 2L9 9H3l5 4-2 7 6-4 6 4-2-7 5-4h-6z"/></svg>',
  run:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
  done:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>',
  fail:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
  star:'<svg viewBox="0 0 24 24" fill="var(--gold)" stroke="var(--gold)" stroke-width="1.5"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
  arr:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>',
  chk:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>',
};

// ===== STATE =====
let allDocs=[],colls=[],collMems={},jobs=JSON.parse(localStorage.getItem('ml_jobs')||'[]');
let starred=new Set(JSON.parse(localStorage.getItem('ml_star')||'[]'));
let notes=JSON.parse(localStorage.getItem('ml_notes')||'{}');
let curTab='lib',curDoc=null,curDocId=null,curWs=null,selResWs=null,selCat=null,selFw=null,selSc='asset',selRi='in-depth',libFil='all';
let chatMsgs=[],isChatting=false,addDocSel=new Set();
let jobId=jobs.reduce((m,j)=>Math.max(m,j.id||0),0);

function saveStar(){localStorage.setItem('ml_star',JSON.stringify([...starred]))}
function saveNotes(){localStorage.setItem('ml_notes',JSON.stringify(notes))}
function saveJobs(){localStorage.setItem('ml_jobs',JSON.stringify(jobs))}

// ===== RESEARCH CONFIG =====
const CATS={company:'Asset Analysis',competitive:'Competitive',ecosystem:'Ecosystem',scenarios:'Scenarios & Risk',custom:'Custom'};
const FWS={
  company:['General Analysis','Valuation Analysis','Financial Health','SWOT Analysis','Leadership Assessment'],
  competitive:['Head-to-Head',"Porter's Five Forces",'Market Share Dynamics','Competitive Response'],
  ecosystem:['Ecosystem Mapping','Supply Chain Contagion','Concentration Risk','Geographic Exposure'],
  scenarios:['Risk Correlation','M&A Scenarios','Interest Rate Sensitivity','Recession Stress Test','Narrative Momentum'],
  custom:['Custom Framework']
};

const PASSWORD='MLmobile';
let authenticated=false;

// ===== LOGIN / LOGOUT =====
async function doLogin(){
  const pw=document.getElementById('login-pw').value.trim();
  const err=document.getElementById('login-err');
  const btn=document.getElementById('login-go');
  err.textContent='';
  if(pw!==PASSWORD){err.textContent='Incorrect password';return}
  btn.disabled=true;btn.textContent='Connecting...';
  try{
    // Verify API key works by getting JWT
    await API.token();
    sessionStorage.setItem('ml_auth','1');
    authenticated=true;
    document.getElementById('login').classList.add('hide');
    document.getElementById('api-st').innerHTML='<span style="color:var(--ok)">Connected — Live</span>';
    initApp();
  }catch(e){
    err.textContent='Authentication failed — check API key';
    btn.disabled=false;btn.textContent='Connect';
  }
}

function doLogout(){
  sessionStorage.removeItem('ml_auth');
  authenticated=false;
  allDocs=[];colls=[];collMems={};
  document.getElementById('login').classList.remove('hide');
  document.getElementById('login-pw').value='';
  document.getElementById('login-err').textContent='';
  document.getElementById('login-go').disabled=false;
  document.getElementById('login-go').textContent='Connect';
  document.getElementById('api-st').innerHTML='<span style="color:var(--muted)">Not connected</span>';
  go('lib');
  
}

async function checkSession(){
  if(sessionStorage.getItem('ml_auth')==='1'){
    try{
      await API.token();
      authenticated=true;
      document.getElementById('login').classList.add('hide');
      document.getElementById('api-st').innerHTML='<span style="color:var(--ok)">Connected — Live</span>';
      initApp();
    }catch(e){
      sessionStorage.removeItem('ml_auth');
    }
  }
}

// ===== INIT =====
async function initApp(){
  document.getElementById('ld').classList.remove('hide');
  try{
    setLd('Loading documents...');
    const raw=await API.loadDocs();
    allDocs=(Array.isArray(raw)?raw:raw?.objects||[]).filter(o=>o.content?.source).map(mapDoc);

    setLd('Loading workspaces...');
    colls=await API.loadColls()||[];

    setLd('Loading workspace contents...');
    for(const c of colls){try{const m=await API.getMembers(c.id)||[];collMems[c.id]=m.map(x=>x.id||x)}catch(e){collMems[c.id]=[]}}

    hideLd();renderLib();renderBadge();
    jobs.filter(j=>j.status==='running'&&j.workflowId&&j.runId).forEach(j=>pollJob(j.id,j.workflowId,j.runId));
  }catch(e){
    console.error('Init failed:',e);
    setLd('Connection failed. Check API key.');
  }
}

window.addEventListener('DOMContentLoaded',()=>{
  initResForm();
  document.getElementById('c-inp').addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendChat()}});
  document.getElementById('login-pw').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin()});
  jobs=jobs.filter(j=>{if(j.status==='running'&&Date.now()-j.startedAt>600000){j.status='failed';j.statusText='Timed out';return true}return true});
  saveJobs();
  checkSession();
});

function mapDoc(o){return{id:o.id,title:o.name||'Untitled',type:o.properties?.framework||o.properties?.document_type||'Research',date:o.created_at,source:o.content?.source,parentId:o.parent?.id||o.parent||o.properties?.parent_document_id||null}}
function cleanTitle(t){if(!t)return'Untitled';return t.replace(/^Deep Research:\s*/i,'').replace(/\s+-\s+[\w\s]+-\s+[\w\s]+-\s+[\w\s]+$/,'')||t}
function fmtD(s){if(!s)return'';return new Date(s).toLocaleDateString('en-US',{month:'short',day:'numeric'})}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function setLd(t){document.getElementById('ld-t').textContent=t}
function hideLd(){document.getElementById('ld').classList.add('hide')}

// ===== NAV =====
function go(t){
  curTab=t;
  ['lib','res','ws'].forEach(v=>{const e=document.getElementById('v-'+v);if(e)e.classList.toggle('on',v===t)});
  document.querySelectorAll('.tab').forEach(e=>e.classList.toggle('on',e.dataset.t===t));
  if(t==='lib')renderLib();if(t==='ws')renderWs();
}

// ===== ACTIVITY (inline in library) =====
function typeStrip(t){
  if(!t)return'default';
  const l=t.toLowerCase();
  if(l.includes('research')||l.includes('report'))return'research';
  if(l.includes('analy')||l.includes('assessment'))return'analysis';
  if(l.includes('valuat')||l.includes('financ'))return'valuation';
  if(l.includes('eco')||l.includes('market')||l.includes('landscape'))return'ecosystem';
  return'default';
}

function renderActivity(){
  const el=document.getElementById('lib-activity');
  const running=jobs.filter(j=>j.status==='running');
  const completed=jobs.filter(j=>j.status==='completed');
  const failed=jobs.filter(j=>j.status==='failed');
  const hasJobs=running.length||completed.length||failed.length;
  if(!hasJobs&&allDocs.length){el.innerHTML='';return}

  let h='';
  if(hasJobs){
    h+='<div class="sec" style="padding-top:4px">Research Activity</div>';
    running.forEach(j=>{
      const el=Math.floor((Date.now()-j.startedAt)/1000);const m=Math.floor(el/60);const s=el%60;
      h+=`<div class="jc"><div class="jc-st-strip run"></div><div class="jc-inner"><div class="jc-ic run">${IC.run}</div><div class="jc-bd"><div class="jc-n">${esc(j.name)}</div><div class="jc-st">${j.statusText||'Running...'} · ${m}m ${s}s</div><div class="jc-bar"><div class="jc-fill"></div></div></div></div></div>`;
    });
    completed.forEach(j=>{
      h+=`<div class="jc"><div class="jc-st-strip done"></div><div class="jc-inner"><div class="jc-ic done">${IC.done}</div><div class="jc-bd"><div class="jc-n">${esc(j.docTitle||j.name)}</div><div class="jc-st">Complete</div><div class="jc-acts">${j.docId?`<button class="btn btn-p btn-sm" onclick="openDocById('${j.docId}')">Read</button>`:''}<button class="btn btn-sm btn-s" onclick="dismissJob(${j.id})">Dismiss</button></div></div></div></div>`;
    });
    failed.forEach(j=>{
      h+=`<div class="jc"><div class="jc-st-strip fail"></div><div class="jc-inner"><div class="jc-ic fail">${IC.fail}</div><div class="jc-bd"><div class="jc-n">${esc(j.name)}</div><div class="jc-st">${j.failReason||'Failed'}</div><div class="jc-acts"><button class="btn btn-sm btn-s" onclick="dismissJob(${j.id})">Dismiss</button></div></div></div></div>`;
    });
  }

  if(!hasJobs&&!allDocs.length){
    h+=`<div style="text-align:center;padding:40px 32px 24px">
      <svg width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" style="opacity:.2;margin-bottom:12px"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/><line x1="11" y1="8" x2="11" y2="14"/></svg>
      <div style="font-size:15px;font-weight:500;color:var(--ink)">No research yet</div>
      <div style="font-size:13px;color:var(--muted);margin-top:4px">Generate your first analysis to get started</div>
      <button class="btn btn-p" onclick="go('res')" style="margin-top:14px">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        New Research
      </button>
    </div>`;
  }

  el.innerHTML=h;
}

function docCard(d){
  const ws=colls.find(c=>collMems[c.id]?.includes(d.id));
  const st=typeStrip(d.type);
  return`<div class="dc" onclick="openDocById('${d.id}')"><div class="dc-in"><div class="dc-strip t-${st}"></div><div class="dc-bd"><div class="dc-t">${esc(cleanTitle(d.title))}</div><div class="dc-meta"><span class="dc-type">${esc(d.type)}</span>${ws?`<span class="dt"></span><span>${esc(ws.name)}</span>`:''}<span class="dt"></span><span>${fmtD(d.date)}</span></div></div>${starred.has(d.id)?`<span class="dc-star">${IC.star}</span>`:''}<div class="dc-arr">${IC.arr}</div></div></div>`;
}

function docLi(d){
  const ws=colls.find(c=>collMems[c.id]?.includes(d.id));
  return`<div class="li" onclick="openDocById('${d.id}')"><div class="li-ic doc">${IC.doc}</div><div class="li-bd"><div class="li-t">${esc(cleanTitle(d.title))}</div><div class="li-s"><span>${esc(d.type)}</span>${ws?`<span class="dt"></span><span>${esc(ws.name)}</span>`:''}<span class="dt"></span><span>${fmtD(d.date)}</span></div></div>${starred.has(d.id)?`<span class="li-star">${IC.star}</span>`:''}<div class="li-arr">${IC.arr}</div></div>`;
}

// ===== LIBRARY =====
function renderLib(){
  renderActivity();
  const chEl=document.getElementById('lib-ch');
  chEl.innerHTML=['all','starred','recent'].map(f=>`<button class="ch ${libFil===f?'on':''}" onclick="libFil='${f}';renderLib()">${f==='starred'?'Starred':f==='recent'?'Recent':'All'}</button>`).join('');
  let fl=[...allDocs];const q=(document.getElementById('lib-q')?.value||'').toLowerCase();
  if(q)fl=fl.filter(d=>d.title.toLowerCase().includes(q)||d.type.toLowerCase().includes(q));
  if(libFil==='starred')fl=fl.filter(d=>starred.has(d.id));
  fl.sort((a,b)=>new Date(b.date)-new Date(a.date));
  const el=document.getElementById('lib-ls');
  if(!fl.length){el.innerHTML='<div class="emp"><div class="emp-t">'+(q?'No matches':'Your library is empty')+'</div><p>'+(q?'Try different keywords':'Documents you generate will appear here')+'</p></div>';return}
  el.innerHTML='<div style="padding-top:4px">'+fl.map(d=>docCard(d)).join('')+'</div>';
}

// ===== WORKSPACES =====
function renderWs(){
  const el=document.getElementById('ws-ls');
  if(!colls.length){el.innerHTML='<div class="emp"><div class="emp-t">No workspaces yet</div><p>Organize your research into themed collections</p><button class="btn btn-p btn-sm" onclick="newWorkspace()" style="margin-top:12px">Create Workspace</button></div>';return}
  el.innerHTML='<div style="padding-top:4px">'+colls.map(c=>{
    const n=(collMems[c.id]||[]).length;
    return`<div class="wsc" onclick="openWsd('${c.id}')"><div class="wsc-in"><div class="wsc-ic">${IC.ws}</div><div class="wsc-bd"><div class="wsc-t">${esc(c.name)}</div><div class="wsc-s">${n} document${n!==1?'s':''}</div></div><div class="wsc-arr">${IC.arr}</div></div></div>`;
  }).join('')+'</div>';
}
function openWsd(cid){
  curWs=colls.find(c=>c.id===cid);if(!curWs)return;
  document.getElementById('wsd-t').textContent=curWs.name;
  const ids=collMems[cid]||[];const ds=ids.map(id=>allDocs.find(d=>d.id===id)).filter(Boolean);
  document.getElementById('wsd-inf').textContent=`${ds.length} document${ds.length!==1?'s':''}`;
  document.getElementById('wsd-docs').innerHTML=ds.length?'<div style="padding-top:4px">'+ds.map(d=>docCard(d)).join('')+'</div>':'<div class="emp"><div class="emp-t">Empty workspace</div><p>Add documents or run research into this collection</p></div>';
  document.getElementById('wsd').classList.add('open');
}
function closeWsd(){document.getElementById('wsd').classList.remove('open');curWs=null}
async function newWorkspace(){
  const n=prompt('Workspace name:');if(!n)return;
  try{const c=await API.createColl(n.trim());colls.push(c);collMems[c.id]=[];renderWs();toast('Workspace created')}catch(e){toast('Failed to create workspace','err')}
}

// ===== ADD DOCS TO WORKSPACE =====
function openAddDocSheet(){
  if(!curWs)return;
  addDocSel=new Set();
  const existing=new Set(collMems[curWs.id]||[]);
  const available=allDocs.filter(d=>!existing.has(d.id));
  const el=document.getElementById('adddoc-ls');
  if(!available.length){el.innerHTML='<div class="emp"><p>All documents are already in this workspace</p></div>';openSh('sh-adddoc');return}
  el.innerHTML=available.map(d=>`<div class="li" onclick="toggleAddDoc('${d.id}',this)"><div class="li-ic doc">${IC.doc}</div><div class="li-bd"><div class="li-t">${esc(cleanTitle(d.title))}</div><div class="li-s"><span>${esc(d.type)}</span><span class="dt"></span><span>${fmtD(d.date)}</span></div></div><div class="ws-chk" id="adc-${d.id}">${IC.chk}</div></div>`).join('');
  openSh('sh-adddoc');
}
function toggleAddDoc(id,el){
  if(addDocSel.has(id))addDocSel.delete(id);else addDocSel.add(id);
  document.getElementById('adc-'+id)?.classList.toggle('on',addDocSel.has(id));
}
async function confirmAddDocs(){
  if(!addDocSel.size||!curWs){closeSh();return}
  try{
    await API.addToColl(curWs.id,[...addDocSel]);
    const m=await API.getMembers(curWs.id)||[];collMems[curWs.id]=m.map(x=>x.id||x);
    closeSh();openWsd(curWs.id);toast(`${addDocSel.size} document${addDocSel.size>1?'s':''} added`);
  }catch(e){toast('Failed to add documents','err')}
}

// ===== READER =====
async function openDocById(id){
  const d=allDocs.find(x=>x.id===id);if(!d)return;
  curDoc=d;curDocId=id;chatMsgs=[];
  document.getElementById('rdr-tt').textContent=cleanTitle(d.title);
  document.getElementById('rdr-bd').innerHTML='<div style="display:flex;align-items:center;justify-content:center;padding:60px;gap:10px"><div class="spin"></div><span style="color:var(--muted);font-size:13px">Loading...</span></div>';
  document.getElementById('rdr').classList.add('open');
  updateStarIcon();
  // Auto-hide header
  let ly=0;const bd=document.getElementById('rdr-bd'),hd=document.getElementById('rdr-h');
  bd.onscroll=()=>{const y=bd.scrollTop;if(y>ly&&y>60)hd.classList.add('hid');else hd.classList.remove('hid');ly=y};
  try{
    const content=await API.getContent(d.source);
    if(typeof marked!=='undefined'){marked.setOptions({breaks:true});document.getElementById('rdr-bd').innerHTML=marked.parse(content)}
    else document.getElementById('rdr-bd').innerHTML='<pre style="white-space:pre-wrap;font-size:14px">'+esc(content)+'</pre>';
  }catch(e){document.getElementById('rdr-bd').innerHTML='<div style="text-align:center;padding:60px;color:var(--err)"><p>Failed to load document</p><p style="font-size:13px;margin-top:4px">'+esc(e.message)+'</p></div>'}
}
function closeRdr(){document.getElementById('rdr').classList.remove('open');curDoc=null;curDocId=null}
function openRdrMenu(){toast('Actions menu coming soon')}
function toggleStar(){
  if(!curDocId)return;
  if(starred.has(curDocId))starred.delete(curDocId);else starred.add(curDocId);
  saveStar();updateStarIcon();
}
function updateStarIcon(){
  const s=document.getElementById('rdr-star');
  if(curDocId&&starred.has(curDocId)){s.setAttribute('fill','var(--gold)');s.setAttribute('stroke','var(--gold)')}
  else{s.setAttribute('fill','none');s.setAttribute('stroke','currentColor')}
}

// ===== SHEETS =====
let curSh=null;
function openSh(id){closeSh();curSh=id;document.getElementById('shbg').classList.add('on');document.getElementById(id).classList.add('on')}
function closeSh(){document.getElementById('shbg').classList.remove('on');if(curSh)document.getElementById(curSh).classList.remove('on');curSh=null}

// ===== DOC CHAT =====
function openDocChat(){
  if(!curDoc)return;
  document.getElementById('sh-chat-t').textContent=cleanTitle(curDoc.title);
  const m=document.getElementById('c-msgs');
  if(!chatMsgs.length)m.innerHTML='<div class="emp" style="padding:24px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg><p>Ask questions about this document</p></div>';
  openSh('sh-chat');
}
async function sendChat(){
  const inp=document.getElementById('c-inp');const msg=inp.value.trim();if(!msg||isChatting)return;
  isChatting=true;
  const el=document.getElementById('c-msgs');
  if(!chatMsgs.length)el.innerHTML='';
  const t=new Date().toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
  el.innerHTML+=`<div class="c-m u"><div class="c-b">${esc(msg)}</div><div class="c-t">You · ${t}</div></div>`;
  chatMsgs.push({role:'user',content:msg});
  inp.value='';el.scrollTop=el.scrollHeight;

  // Thinking indicator
  el.innerHTML+='<div class="c-m a" id="c-thk"><div class="thk"><div class="thk-d"><span></span><span></span><span></span></div>Analyzing...</div></div>';
  el.scrollTop=el.scrollHeight;

  try{
    let task=`DOCUMENT CONTEXT: Analyze document ID ${curDocId} (${curDoc.title})\n\n`;
    if(chatMsgs.length>1){task+=`Previous conversation:\n${chatMsgs.slice(-10,-1).map(m=>`${m.role==='user'?'User':'Assistant'}: ${m.content}`).join('\n')}\n\n`}
    task+=`Current question: ${msg}`;
    const res=await API.execChat(task);
    if(res?.runId&&res?.workflowId){
      let got=false;
      await API.stream(res.workflowId,res.runId,
        d=>{if(d.type==='answer'&&d.message&&!got){got=true;const ans=API.extractAnswer(d.message);document.getElementById('c-thk')?.remove();addChatReply(ans);isChatting=false}},
        ()=>{if(!got){document.getElementById('c-thk')?.remove();addChatReply('No relevant information found.');isChatting=false}},
        ()=>{document.getElementById('c-thk')?.remove();addChatReply('Error. Please try again.');isChatting=false}
      );
    }else throw new Error('No response');
  }catch(e){document.getElementById('c-thk')?.remove();addChatReply('Connection error. Please try again.');isChatting=false}
}
function addChatReply(txt){
  const el=document.getElementById('c-msgs');const t=new Date().toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
  el.innerHTML+=`<div class="c-m a"><div class="c-b">${formatMd(txt)}</div><div class="c-t">Scout · ${t}</div></div>`;
  chatMsgs.push({role:'assistant',content:txt});el.scrollTop=el.scrollHeight;
}
function formatMd(t){return t.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>')}

// ===== WS CHAT =====
function openWsChat(){
  if(!curWs)return;
  chatMsgs=[];
  document.getElementById('sh-chat-t').textContent=curWs.name;
  document.getElementById('c-msgs').innerHTML='<div class="emp" style="padding:24px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg><p>Ask about all documents in this workspace</p></div>';
  // Override sendChat to use workspace context - simple approach
  curDocId=null;curDoc={title:curWs.name,id:curWs.id};
  openSh('sh-chat');
}

// ===== NOTES =====
function openNotes(){
  if(!curDocId)return;
  document.getElementById('n-ed').value=notes[curDocId]||'';
  openSh('sh-notes');
}
function saveNote(){
  if(!curDocId)return;
  const v=document.getElementById('n-ed').value.trim();
  if(v)notes[curDocId]=v;else delete notes[curDocId];
  saveNotes();closeSh();toast('Notes saved');
}

// ===== FOLLOW UP =====
let followUpDoc=null;

function openFollowUp(){
  if(!curDoc)return;
  followUpDoc={id:curDocId,title:cleanTitle(curDoc.title),type:curDoc.type};

  // Find which workspace this doc belongs to
  selResWs=null;
  for(const c of colls){if((collMems[c.id]||[]).includes(curDocId)){selResWs=c.id;break}}
  const ws=colls.find(c=>c.id===selResWs);

  // Reset form selections
  selCat=null;selFw=null;
  document.querySelectorAll('#r-cats .ch').forEach(x=>x.classList.remove('on'));
  document.getElementById('r-fwg').style.display='none';

  closeSh();closeRdr();go('res');

  setTimeout(()=>{
    // Show parent banner
    const p=document.getElementById('r-parent');
    p.style.display='block';
    document.getElementById('r-parent-title').textContent=followUpDoc.title;
    document.getElementById('r-parent-meta').textContent=followUpDoc.type+(ws?' · '+ws.name:'');

    // Set workspace
    document.getElementById('r-ws-label').textContent=ws?ws.name:'None — library only';
    document.getElementById('r-ws-label').style.color=ws?'var(--ink)':'var(--muted)';

    // Pre-fill context
    document.getElementById('r-ctx').value='';
    document.getElementById('r-ctx').placeholder='What direction should the follow-up take?';
    document.getElementById('r-ctx').focus();
  },120);
}

function clearFollowUp(){
  followUpDoc=null;
  document.getElementById('r-parent').style.display='none';
  document.getElementById('r-ctx').placeholder='Describe your research question...';
  selResWs=null;
  document.getElementById('r-ws-label').textContent='None — library only';
  document.getElementById('r-ws-label').style.color='var(--muted)';
}

// ===== RESEARCH FORM =====
function initResForm(){
  document.getElementById('r-cats').innerHTML=Object.entries(CATS).map(([k,v])=>`<button class="ch" data-c="${k}" onclick="pickCat('${k}')">${v}</button>`).join('');
  document.querySelectorAll('#r-sc .tgl-o').forEach(b=>{b.onclick=()=>{selSc=b.dataset.v;document.querySelectorAll('#r-sc .tgl-o').forEach(x=>x.classList.toggle('on',x===b))}});
  document.querySelectorAll('#r-ri .tgl-o').forEach(b=>{b.onclick=()=>{selRi=b.dataset.v;document.querySelectorAll('#r-ri .tgl-o').forEach(x=>x.classList.toggle('on',x===b))}});
}
function pickCat(c){
  selCat=c;selFw=null;
  document.querySelectorAll('#r-cats .ch').forEach(x=>x.classList.toggle('on',x.dataset.c===c));
  document.getElementById('r-fwg').style.display='block';
  document.getElementById('r-fws').innerHTML=FWS[c].map(f=>`<button class="ch" onclick="pickFw(this,'${f}')">${f}</button>`).join('');
}
function pickFw(el,f){selFw=f;document.querySelectorAll('#r-fws .ch').forEach(x=>x.classList.toggle('on',x===el))}

// WS picker for research
function openWsPick(){
  const el=document.getElementById('wspick-ls');
  let h=`<div class="li" onclick="pickResWs(null)"><div class="li-bd"><div class="li-t" style="color:var(--muted)">None — library only</div></div></div>`;
  colls.forEach(c=>{h+=`<div class="li" onclick="pickResWs('${c.id}')"><div class="li-ic ws">${IC.ws}</div><div class="li-bd"><div class="li-t">${esc(c.name)}</div></div>${selResWs===c.id?`<div class="ws-chk on">${IC.chk}</div>`:''}</div>`});
  el.innerHTML=h;openSh('sh-wspick');
}
function pickResWs(id){
  selResWs=id;
  const ws=colls.find(c=>c.id===id);
  document.getElementById('r-ws-label').textContent=ws?ws.name:'None — library only';
  document.getElementById('r-ws-label').style.color=ws?'var(--ink)':'var(--muted)';
  closeSh();
}

async function doResearch(){
  const ctx=document.getElementById('r-ctx').value.trim();
  if(!selFw){toast('Select a category and framework','err');return}
  if(!ctx){toast('Describe what to research','err');return}

  const btn=document.getElementById('r-go');btn.disabled=true;btn.textContent='Starting...';

  const ws=colls.find(c=>c.id===selResWs);
  let prompt=`Framework: ${selFw}\nScope: ${selSc}\nAnalytical Rigor: ${selRi}\n`;
  if(followUpDoc){prompt+=`\nFOLLOW-UP RESEARCH: This is a follow-up to document "${followUpDoc.title}" (ID: ${followUpDoc.id}). Reference and build upon the parent document.\n`}
  prompt+=`Context: ${ctx}\n\nGenerate a comprehensive research document with hyperlinked sources.\nThe final output must be a document uploaded to the content object library.`;
  if(selResWs&&ws){prompt+=`\n\nFINAL STEP - CRITICAL: After uploading the document to the content library, you MUST:\n- Add the newly created document to collection ID: ${selResWs} (named "${ws.name}") using the add_to_collection tool\n- Confirm completion`}
  else{prompt+='\n\nNOTE: Save to library only — do NOT add to any collection.'}

  try{
    const res=await API.execResearch(prompt);
    const jid=++jobId;
    const job={id:jid,name:ctx.length>50?ctx.substring(0,47)+'...':ctx,status:'running',statusText:'Starting...',workflowId:res.workflowId,runId:res.runId,wsId:selResWs,startedAt:Date.now(),docId:null,docTitle:null,failReason:null};
    jobs.unshift(job);saveJobs();
    pollJob(jid,res.workflowId,res.runId);
    toast('Research started');go('lib');renderBadge();
  }catch(e){toast('Failed to start research','err')}
  btn.disabled=false;btn.textContent='Generate Research';
  // Reset
  document.getElementById('r-ctx').value='';selCat=null;selFw=null;followUpDoc=null;
  document.getElementById('r-parent').style.display='none';
  document.getElementById('r-ctx').placeholder='Describe your research question...';
  document.querySelectorAll('#r-cats .ch').forEach(x=>x.classList.remove('on'));
  document.getElementById('r-fwg').style.display='none';
}

// ===== JOB POLLING =====
const polls={};
function pollJob(jid,wf,run){
  let att=0;
  // Stream status in background
  API.stream(wf,run,d=>{
    if(d.type==='update'&&d.message){const b=bucket(d.message);if(b)updJob(jid,'statusText',b)}
    if(d.message&&d.message.includes('Financial Services only')){failJobById(jid,'Not a financial topic')}
  },null,null);
  polls[jid]=setInterval(async()=>{
    att++;if(att>120){clearInterval(polls[jid]);delete polls[jid];complJob(jid);return}
    try{
      const st=await API.getRunStatus(wf,run);const s=(st?.status||'').toLowerCase();
      if(['completed','success','finished','done','succeeded'].includes(s)){clearInterval(polls[jid]);delete polls[jid];complJob(jid)}
      else if(['failed','error','cancelled'].includes(s)){clearInterval(polls[jid]);delete polls[jid];complJob(jid)}
    }catch(e){}
  },5000);
}
function bucket(m){const l=m.toLowerCase();if(/search|find|look|query|fetch/.test(l))return'Researching sources';if(/read|review|page|document/.test(l))return'Reviewing documents';if(/analyz|evaluat|compar/.test(l))return'Analyzing';if(/synthe|combin|integrat/.test(l))return'Synthesizing';if(/writ|compos|generat|draft/.test(l))return'Composing';if(/upload|save|finish/.test(l))return'Finalizing';return null}
function updJob(jid,k,v){const j=jobs.find(x=>x.id===jid);if(j){j[k]=v;saveJobs();if(curTab==='lib')renderLib()}}
async function complJob(jid){
  const j=jobs.find(x=>x.id===jid);if(!j||j.status==='failed')return;
  j.status='completed';j.statusText='Complete';saveJobs();
  // Reload docs to find the new one
  try{
    const raw=await API.loadDocs();const newDocs=(Array.isArray(raw)?raw:raw?.objects||[]).filter(o=>o.content?.source).map(mapDoc);
    const newIds=new Set(newDocs.map(d=>d.id));const oldIds=new Set(allDocs.map(d=>d.id));
    const added=newDocs.filter(d=>!oldIds.has(d.id));
    allDocs=newDocs;
    if(added.length){j.docId=added[0].id;j.docTitle=cleanTitle(added[0].title);j.name=j.docTitle;saveJobs()}
    if(j.wsId){try{const m=await API.getMembers(j.wsId)||[];collMems[j.wsId]=m.map(x=>x.id||x)}catch(e){}}
  }catch(e){}
  renderLib();renderBadge();toast('Research complete!');
}
function failJobById(jid,r){const j=jobs.find(x=>x.id===jid);if(j){j.status='failed';j.failReason=r;saveJobs();if(polls[jid]){clearInterval(polls[jid]);delete polls[jid]}renderLib();renderBadge()}}
function dismissJob(jid){jobs=jobs.filter(j=>j.id!==jid);saveJobs();renderLib();renderBadge()}
function renderBadge(){
  const n=jobs.filter(j=>j.status==='running').length;
  document.querySelectorAll('.tab .bdg').forEach(b=>b.remove());
  if(n)document.querySelector('.tab[data-t="lib"]')?.insertAdjacentHTML('beforeend',`<span class="bdg">${n}</span>`);
}

// WS research shortcut
function wsNewResearch(){selResWs=curWs?.id||null;const ws=colls.find(c=>c.id===selResWs);document.getElementById('r-ws-label').textContent=ws?.name||'None';document.getElementById('r-ws-label').style.color='var(--ink)';closeWsd();go('res')}

// ===== TOAST =====
function toast(m,ty=''){const c=document.getElementById('toast-c');const t=document.createElement('div');t.className='tst '+ty;t.textContent=m;c.appendChild(t);requestAnimationFrame(()=>t.classList.add('show'));setTimeout(()=>{t.classList.remove('show');setTimeout(()=>t.remove(),300)},2500)}

// Load marked.js
(function(){const s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/marked/marked.min.js';document.head.appendChild(s)})();
</script>
</body>
</html>
